# API Endpoints Verification - Linear Pipeline

**Date:** 2025-11-20
**Status:** ‚úÖ Verified and Fixed

---

## Summary

Verified all API endpoints align with the linear pipeline architecture (Phase 1 ‚Üí 3 ‚Üí 5 ‚Üí 7 ‚Üí 8). Fixed 3 issues in orchestrator.cjs.

---

## Orchestrator Endpoints (Port 3456)

### ‚úÖ **GET /api/courses**
**Purpose:** List all available courses
**Status:** Correct
- No Phase 6 logic
- Returns correct phase completion data

### ‚úÖ **GET /api/courses/:courseCode**
**Purpose:** Get detailed course information
**Status:** Correct
- Checks for seed_pairs.json (Phase 1)
- Checks for lego_pairs.json (Phase 3)
- Checks for lego_baskets.json (Phase 5)
- No separate Phase 6 check

### ‚úÖ **POST /api/courses/generate**
**Purpose:** Trigger course generation from dashboard
**Status:** Fixed
**Changes made:**
```javascript
// BEFORE (lines 859-860):
} else if (phaseSelection === 'phase6') {
  phase = 6;

// AFTER:
} else if (phaseSelection === 'phase7') {
  phase = 7;
} else if (phaseSelection === 'phase8') {
  phase = 8;
```

**Supported phaseSelection values:**
- `'phase1'` ‚Üí Triggers Phase 1 server (port 3457)
- `'phase3'` ‚Üí Triggers Phase 3 server (port 3458) - includes intro generation
- `'phase5'` ‚Üí Triggers Phase 5 server (port 3459)
- `'phase7'` ‚Üí Triggers Phase 7 server (port 3462)
- `'phase8'` ‚Üí Triggers Phase 8 server (port 3463)
- `'all'` ‚Üí Starts from Phase 1, triggers entire pipeline

### ‚úÖ **POST /phase-complete**
**Purpose:** Callback from phase servers when they complete
**Status:** Fixed
**Changes made:**
```javascript
// BEFORE (line 719):
 * Handles parallel phase coordination (Phase 5 + Phase 6 after Phase 3)

// AFTER:
 * Triggers next phase in linear sequence: 1 ‚Üí 3 ‚Üí 5 ‚Üí 7 ‚Üí 8
```

**Linear progression logic:**
```javascript
Phase 1 complete ‚Üí Trigger Phase 3 (2s delay)
Phase 3 complete ‚Üí Trigger Phase 5 (2s delay) // Phase 6 intros already generated inline
Phase 5 complete ‚Üí Trigger Phase 7 (2s delay)
Phase 7 complete ‚Üí Trigger Phase 8 (2s delay)
Phase 8 complete ‚Üí Status = 'complete' üéâ
```

### ‚úÖ **GET /api/courses/:courseCode/status**
**Purpose:** Get current generation status for polling
**Status:** Correct
- Returns phase, status, message, subProgress
- No Phase 6 status tracking

### ‚úÖ **GET /api/vfs/courses/:code/:file(*)**
**Purpose:** Serve VFS files for dashboard
**Status:** Correct
- Serves any file from course directory
- Works for introductions.json (generated by Phase 3)

---

## Phase Server Endpoints

### **Phase 1 Server (Port 3457)**
**POST /start** - Trigger Phase 1 translation
**POST /phase-complete** - Notifies orchestrator when done

### **Phase 3 Server (Port 3458)**
**POST /start** - Trigger Phase 3 LEGO extraction
**Behavior:**
- Extracts LEGOs
- Deduplicates
- Calls `generateIntroductions()` inline (~20ms)
- Notifies orchestrator with Phase 3 complete

**POST /phase-complete** - Notifies orchestrator when done

### **Phase 5 Server (Port 3459)**
**POST /start** - Trigger Phase 5 basket generation
**POST /phase-complete** - Notifies orchestrator when done

### **Phase 5.5 Server (Port 3460)**
**POST /start** - Trigger grammar validation
**Called by:** Phase 5 server (not orchestrator directly)

### **Phase 7 Server (Port 3462)**
**POST /start** - Trigger manifest compilation
**POST /phase-complete** - Notifies orchestrator when done

### **Phase 8 Server (Port 3463)**
**POST /start** - Trigger audio/TTS generation
**POST /phase-complete** - Notifies orchestrator when done

### **Phase 6 Server (Port 3461) - DEPRECATED**
**Status:** ‚ùå Not started by automation
**File exists:** Yes (services/phases/phase6-introduction-server.cjs)
**Usage:** None - functionality integrated into Phase 3
**Action:** Can be deleted or kept for standalone testing

---

## Frontend API Client (src/services/api.js)

### ‚úÖ **course.generate()**
**Status:** Correct
**Routing logic:**
```javascript
if (phaseSelection === 'phase5') {
  // Special case: Phase 5 goes directly to Phase 5 server
  return await api.post('/phase5/start', { ... })
}

// All other phases route through orchestrator
return await api.post('/api/courses/generate', {
  target, known, startSeed, endSeed, phaseSelection
})
```

**No Phase 6 references** ‚úÖ

### ‚úÖ **course.getDetails()**
**Status:** Correct
**File checks:**
- seed_pairs.json (Phase 1)
- lego_pairs.json (Phase 3)
- lego_baskets.json (Phase 5)
- introductions.json (Phase 3, originally Phase 6) ‚úÖ

**Comment on line 302** notes "Phase 6" origin but this is informational only - file is checked correctly.

---

## Issues Found & Fixed

### üî¥ **Issue 1: Orchestrator Accepted Phase 6 Selection**
**Location:** orchestrator.cjs:859-860
**Problem:** Code accepted `phaseSelection === 'phase6'` but Phase 6 server doesn't exist
**Impact:** Would throw "Phase 6 server not available" error if called
**Fix:**
- Removed Phase 6 case
- Added Phase 7 and Phase 8 cases
**Status:** ‚úÖ Fixed

### üî¥ **Issue 2: Outdated Parallel Coordination Comment**
**Location:** orchestrator.cjs:719
**Problem:** Comment said "Handles parallel phase coordination (Phase 5 + Phase 6 after Phase 3)"
**Impact:** Misleading documentation
**Fix:** Updated to "Triggers next phase in linear sequence: 1 ‚Üí 3 ‚Üí 5 ‚Üí 7 ‚Üí 8"
**Status:** ‚úÖ Fixed

### üî¥ **Issue 3: Outdated pipelineJobs Comment**
**Location:** orchestrator.cjs:63-64
**Problem:** Comment mentioned `phase6` in Map structure
**Impact:** Misleading documentation
**Fix:** Updated to show linear flow and removed phase6 reference
**Status:** ‚úÖ Fixed

---

## Port Allocation Verification

| Service | Port | Configured | Active |
|---------|------|-----------|--------|
| Orchestrator | 3456 | ‚úÖ | ‚úÖ |
| Phase 1 | 3457 | ‚úÖ | ‚úÖ |
| Phase 3 | 3458 | ‚úÖ | ‚úÖ |
| Phase 5 | 3459 | ‚úÖ | ‚úÖ |
| Phase 5.5 | 3460 | ‚úÖ | ‚úÖ |
| **Phase 6** | **3461** | ‚ùå | ‚ùå |
| Phase 7 | 3462 | ‚úÖ | ‚úÖ |
| Phase 8 | 3463 | ‚úÖ | ‚úÖ |

**Note:** Port 3461 is intentionally unused (was Phase 6, now deprecated).

---

## PHASE_SERVERS Configuration

**Location:** orchestrator.cjs:32-39

```javascript
const PHASE_SERVERS = {
  1: 'http://localhost:3457',    // Translation (includes Phase 2 LUT)
  3: 'http://localhost:3458',    // LEGO Extraction (includes Phase 6 introductions)
  5: 'http://localhost:3459',    // Practice Baskets
  5.5: 'http://localhost:3460',  // Grammar Validation
  7: 'http://localhost:3462',    // Manifest Compilation
  8: 'http://localhost:3463'     // Audio/TTS
};
```

**Verified:** No Phase 6 entry ‚úÖ

---

## Environment Variables

**Location:** start-automation.cjs:171-176

```javascript
PHASE1_URL: 'http://localhost:3457',
PHASE3_URL: 'http://localhost:3458',
PHASE5_URL: 'http://localhost:3459',
PHASE5_5_URL: 'http://localhost:3460',
PHASE7_URL: 'http://localhost:3462',
PHASE8_URL: 'http://localhost:3463'
```

**Verified:** No PHASE6_URL ‚úÖ

---

## Complete Request Flow

### **Scenario: User clicks "Generate Course" ‚Üí All Phases**

1. **Frontend** (CourseGeneration.vue)
   ```javascript
   api.course.generate({
     target: 'spa',
     known: 'eng',
     phaseSelection: 'all',
     executionMode: 'local'
   })
   ```

2. **API Client** (api.js)
   ```javascript
   POST http://localhost:3456/api/courses/generate
   {
     target: 'spa',
     known: 'eng',
     phaseSelection: 'all'
   }
   ```

3. **Orchestrator** receives request
   - phaseSelection = 'all' ‚Üí phase = 1
   - Looks up PHASE_SERVERS[1] = 'http://localhost:3457'
   - Delegates to Phase 1 server

4. **Phase 1 Server** (port 3457)
   ```javascript
   POST /start
   // Generates seed_pairs.json
   // When complete:
   POST http://localhost:3456/phase-complete
   {
     phase: 1,
     courseCode: 'spa_for_eng',
     status: 'complete'
   }
   ```

5. **Orchestrator** receives /phase-complete
   - Sees phase = 1 complete
   - Triggers Phase 3 after 2s delay

6. **Phase 3 Server** (port 3458)
   ```javascript
   POST /start
   // Extracts LEGOs
   // Generates lego_pairs.json
   // Calls generateIntroductions() inline (~20ms)
   // Generates introductions.json
   // When complete:
   POST http://localhost:3456/phase-complete
   {
     phase: 3,
     courseCode: 'spa_for_eng',
     status: 'complete'
   }
   ```

7. **Orchestrator** receives /phase-complete
   - Sees phase = 3 complete (introductions already done)
   - Triggers Phase 5 after 2s delay

8. **Phase 5 Server** (port 3459)
   ```javascript
   POST /start
   // Generates baskets
   // Triggers Phase 5.5 grammar validation
   // Waits for Phase 5.5 to complete
   // Generates lego_baskets.json
   // When complete:
   POST http://localhost:3456/phase-complete
   {
     phase: 5,
     courseCode: 'spa_for_eng',
     status: 'complete'
   }
   ```

9. **Orchestrator** receives /phase-complete
   - Sees phase = 5 complete
   - Triggers Phase 7 after 2s delay

10. **Phase 7 Server** (port 3462)
    ```javascript
    POST /start
    // Compiles manifest
    // Generates course_manifest.json
    // When complete:
    POST http://localhost:3456/phase-complete
    {
      phase: 7,
      courseCode: 'spa_for_eng',
      status: 'complete'
    }
    ```

11. **Orchestrator** receives /phase-complete
    - Sees phase = 7 complete
    - Triggers Phase 8 after 2s delay

12. **Phase 8 Server** (port 3463)
    ```javascript
    POST /start
    // Generates audio files
    // When complete:
    POST http://localhost:3456/phase-complete
    {
      phase: 8,
      courseCode: 'spa_for_eng',
      status: 'complete'
    }
    ```

13. **Orchestrator** receives /phase-complete
    - Sees phase = 8 complete
    - Sets status = 'complete' üéâ

14. **Frontend** polling detects completion
    - ProgressMonitor shows all phases complete
    - User sees success message

---

## Validation Checklist

- [x] Orchestrator PHASE_SERVERS has no Phase 6 entry
- [x] POST /api/courses/generate rejects 'phase6' selection
- [x] POST /api/courses/generate supports phase7 and phase8
- [x] POST /phase-complete uses linear progression logic
- [x] Frontend API client has no Phase 6 routing
- [x] start-automation.cjs has no Phase 6 service
- [x] Environment variables have no PHASE6_URL
- [x] Phase 3 server generates introductions inline
- [x] All ports correctly allocated (no conflicts)
- [x] Comments updated to reflect linear flow

---

## Success Criteria

‚úÖ **No Phase 6 endpoint routing**
‚úÖ **Linear flow: 1 ‚Üí 3 ‚Üí 5 ‚Üí 7 ‚Üí 8**
‚úÖ **Phase 3 generates introductions inline**
‚úÖ **All phase servers accessible on correct ports**
‚úÖ **Frontend can trigger all valid phases**
‚úÖ **Orchestrator correctly progresses through phases**

---

## Optional Cleanup

**File to consider removing:**
- `services/phases/phase6-introduction-server.cjs` (deprecated, not used)

**Recommendation:** Keep for now - could be useful for standalone testing of intro generation.

---

**Status:** ‚úÖ All API endpoints verified and aligned with linear pipeline
