# SSoT Inventory - What We Have

**Question**: What are all the SSoT components and where are they?
**Answer**: We have a **3-tier distributed SSoT** because the monolithic APML grew too large

---

## The Complete SSoT Map

### TIER 1: Source SSoT (What Developers Edit)

#### 1. Phase Methodology
**Location**: `docs/phase_intelligence/`
**Format**: Markdown files
**Current Files**:
- ✅ `phase_3_extraction.md` (v2.0 - ACTIVE)
- ⏳ `phase_1_translation.md` (pending creation)
- ⏳ `phase_5_baskets.md` (pending creation)
- ⏳ `phase_6_introductions.md` (future)
- ✅ `README.md` (module catalog)

**Authority**: What methodology agents should follow
**Version Control**: Git (each module independently tracked)

---

#### 2. Data Structure Schemas
**Location**: `schemas/`
**Format**: JSON Schema files
**Current Files**:
- ✅ `phase1-seed_pairs.json` - Translation pair format
- ✅ `phase3-lego_pairs.json` - LEGO extraction format
- ✅ `phase5-lego_baskets.json` - Basket format
- ✅ `README.md` - Schema documentation

**Authority**: What data structure is valid
**Version Control**: Git
**Used By**: Validators (AJV)

---

#### 3. Variable Configuration
**Location**: `ssi-course-production.apml`
**Format**: APML (structured text)
**Contains**:
- TOTAL_SEEDS: 668
- BATCH_SIZES per phase
- VFS_PATHS
- System configuration

**Authority**: System-wide constants and configuration
**Version Control**: Git

---

#### 4. Legacy Prompts (Backwards Compatibility)
**Location**: `ssi-course-production.apml`
**Format**: APML PROMPT sections
**Status**: DEPRECATED (but kept for fallback)
**Contains**: Full prompt text for phases 1-5.5
**Migration Target**: Phase intelligence modules

---

### TIER 2: Compiled SSoT (Build Artifact)

#### 5. APML Registry
**Location**: `.apml-registry.json`
**Format**: JSON
**Current Version**: 7.7.0 (→ will be 7.7.1 after update)
**Generated By**: `node scripts/compile-apml-registry.cjs`

**Contains**:
```json
{
  "version": "7.7.1",

  "architecture": {
    // Documents the 3-tier SSoT model
  },

  "phase_intelligence": {
    // References to phase methodology modules
    "modules": {
      "phase_3": {
        "source_file": "docs/phase_intelligence/phase_3_extraction.md",
        "current_version": "2.0",
        "status": "active"
      }
    }
  },

  "variable_registry": {
    // Compiled from APML
    "TOTAL_SEEDS": 668,
    "BATCH_SIZES": {...}
  },

  "PHASE_PROMPTS": {
    // Legacy prompts (backwards compatibility)
    "deprecation_notice": "Use phase_intelligence instead"
  }
}
```

**Authority**: Pointer index connecting Tier 1 to Tier 3
**Purpose**:
- Fast lookups
- Cross-references
- Backwards compatibility
- Version tracking

---

### TIER 3: Runtime SSoT (What Agents Read)

#### 6. Dashboard API
**Location**: `automation_server.cjs` (runs on port 3456)
**Format**: REST API
**Status**: Partially implemented

**Implemented Endpoints**:
- ✅ `GET /api/prompts/:phase` - Legacy prompt access
- ✅ `PUT /api/prompts/:phase` - Update legacy prompts
- ✅ `GET /api/prompts/:phase/history` - Git history
- ✅ `GET /api/courses/:code` - Course data
- ✅ `GET /api/courses/:code/vfs/:filename` - VFS files

**Pending Endpoints** (code ready, needs insertion):
- ⏳ `GET /api/phase-intelligence` - List modules
- ⏳ `GET /api/phase-intelligence/:phase` - Fetch methodology
- ⏳ `PUT /api/phase-intelligence/:phase` - Publish updates
- ⏳ `GET /api/phase-intelligence/:phase/history` - Git history
- ⏳ `GET /api/phase-intelligence/:phase/diff/:old/:new` - Version diff

**Authority**: What agents ACTUALLY execute
**Data Source**: Reads from Tier 1 files, via Tier 2 registry

---

#### 7. Course Data (VFS)
**Location**: `vfs/courses/{code}/`
**Format**: JSON files
**Examples**:
- `seed_pairs.json` - Translations
- `lego_pairs.json` - Extracted LEGOs
- `lego_baskets.json` - Practice phrases

**Authority**: Generated course content
**Not SSoT**: This is OUTPUT, not methodology
**Served By**: Dashboard API

---

## SSoT Authority Flow

```
┌─────────────────────────────────────────────────────┐
│ TIER 1: Source (Developers Edit)                    │
│                                                      │
│ docs/phase_intelligence/phase_3_extraction.md (v2.0)│
│ "Prepositions must be wrapped in composites"       │
└───────────────────┬─────────────────────────────────┘
                    │
                    │ compile-apml-registry.cjs
                    │
                    ▼
┌─────────────────────────────────────────────────────┐
│ TIER 2: Compiled (Pointer Index)                    │
│                                                      │
│ .apml-registry.json (v7.7.1)                        │
│ phase_intelligence.modules.phase_3:                 │
│   source_file: "docs/.../phase_3_extraction.md"    │
│   current_version: "2.0"                            │
│   dashboard_endpoint: "/api/phase-intelligence/3"  │
└───────────────────┬─────────────────────────────────┘
                    │
                    │ automation_server.cjs loads
                    │
                    ▼
┌─────────────────────────────────────────────────────┐
│ TIER 3: Runtime (Agents Read)                       │
│                                                      │
│ Dashboard API: http://localhost:3456                │
│ GET /api/phase-intelligence/3                       │
│ → Reads phase_3_extraction.md                       │
│ → Returns v2.0 methodology                          │
└───────────────────┬─────────────────────────────────┘
                    │
                    │ Agent applies
                    │
                    ▼
              LEGO Extraction
         (using v2.0 methodology)
```

---

## What Gets Updated Where

### Scenario: Discover New Intelligence

**Step 1 - Update Source (Tier 1)**:
```bash
# Edit methodology
vim docs/phase_intelligence/phase_3_extraction.md
# Bump version 2.0 → 2.1
# Add new intelligence
git commit -m "Add composability scoring rules"
```

**Step 2 - Update Registry (Tier 2)**:
```bash
# Open registry
vim .apml-registry.json
# Update phase_intelligence.modules.phase_3.current_version = "2.1"
# Update version: 7.7.1 → 7.7.2
git commit -m "v7.7.2: Update phase 3 to v2.1"
```

**Step 3 - Publish Runtime (Tier 3)**:
```bash
# Publish to dashboard
curl -X PUT http://localhost:3456/api/phase-intelligence/3 \
  -H "Content-Type: application/json" \
  -d @payload.json
```

**Result**: Agents now read v2.1 methodology

---

### Scenario: Change System Variable

**Step 1 - Update Source (Tier 1)**:
```bash
# Edit APML
vim ssi-course-production.apml
# Change BATCH_SIZES.PHASE_3 = 30
git commit -m "Increase Phase 3 batch size to 30"
```

**Step 2 - Regenerate Registry (Tier 2)**:
```bash
# Compile
node scripts/compile-apml-registry.cjs
# Registry now has new batch size
git add .apml-registry.json
git commit -m "Regenerate registry with new batch size"
```

**Step 3 - Restart Server (Tier 3)**:
```bash
# Restart to load new config
pm2 restart automation-server
# OR
node automation_server.cjs
```

**Result**: Agents use new batch size

---

### Scenario: Update Data Schema

**Step 1 - Update Source (Tier 1)**:
```bash
# Edit schema
vim schemas/phase3-lego_pairs.json
# Add "composability_score" field
git commit -m "Add composability score to lego_pairs schema"
```

**Step 2 - No Registry Update Needed**:
Schemas are loaded directly by validators at runtime.

**Step 3 - Automatic**:
Next time validator runs, it uses new schema.

**Result**: Future courses validated against new schema

---

## Summary Table

| Component | Tier | Location | Format | Version | Status |
|-----------|------|----------|--------|---------|--------|
| Phase 3 Methodology | 1 | `docs/phase_intelligence/phase_3_extraction.md` | Markdown | 2.0 | ✅ Active |
| Phase 1 Methodology | 1 | `docs/phase_intelligence/phase_1_translation.md` | Markdown | - | ⏳ Pending |
| Data Schemas | 1 | `schemas/*.json` | JSON Schema | - | ✅ Active |
| Variables | 1 | `ssi-course-production.apml` | APML | - | ✅ Active |
| Legacy Prompts | 1 | `ssi-course-production.apml` | APML | - | ⚠️ Deprecated |
| APML Registry | 2 | `.apml-registry.json` | JSON | 7.7.0 | ⏳ → 7.7.1 |
| Phase Intelligence API | 3 | Dashboard endpoints | REST API | - | ⏳ Pending |
| Legacy Prompt API | 3 | Dashboard endpoints | REST API | - | ✅ Active |
| Course Data | 3 | `vfs/courses/` | JSON files | - | ✅ Active |

---

## What Needs to Happen Next

### Immediate (Today):
1. ✅ Phase 3 methodology created (v2.0)
2. ✅ API endpoints code written
3. ⏳ **Update registry to v7.7.1** (add phase_intelligence section)
4. ⏳ **Add API endpoints to automation_server.cjs**
5. ⏳ Test endpoints

### This Week:
1. Create Phase 1 methodology module
2. Create Phase 5 methodology module
3. Migrate one agent to use new endpoints

### This Month:
1. Dashboard UI for viewing/editing modules
2. All agents migrated to phase intelligence
3. Deprecate legacy PHASE_PROMPTS
4. Full version tracking in production

---

## Key Insight

**We don't have "one big APML" anymore.**

**We have**:
- Modular source files (easy to edit)
- Compiled registry (pointer index)
- Runtime API (what agents read)

**The registry connects them all** - it's the map that shows where everything lives and how it relates.

**Next action**: Update registry to v7.7.1 to document this architecture.
