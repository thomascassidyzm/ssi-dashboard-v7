# APML Registry vs Live Markdown Docs - Forensic Audit

**Date**: 2025-11-17
**Auditor**: Claude (Forensic Analysis Agent)
**Scope**: Determine actual source of truth for phase intelligence and migration status

---

## Executive Summary

**FINDING**: The system is in **ACTIVE MIGRATION** from APML to markdown-based documentation.

**CURRENT SSOT**: **Markdown files in `public/docs/phase_intelligence/`** are the active source of truth.

**APML STATUS**: Mixed - some content in `apml/` directory is being maintained, but **NOT** used at runtime. The `ssi-course-production.apml` file contains outdated phase prompts.

**REGISTRY STATUS**: `.apml-registry.json` is a **generated/compiled artifact** that is NOT the primary source of truth - it's a cached index pointing to markdown files.

---

## File Inventory

### 1. Main APML File: `ssi-course-production.apml`

**Location**: `/Users/tomcassidy/SSi/ssi-dashboard-v7-clean/ssi-course-production.apml`
**Size**: 3,745 lines
**Status**: üî∂ **LEGACY/DEPRECATED for phase intelligence**

**Contents**:
- System metadata (version 7.8.2, APML version 1.1.0)
- Changelog documenting format consolidation (v7.7.0)
- OLD phase prompts embedded in APML structure
- File structure specifications

**Last significant update**: 2025-10-23 (v7.7.0 format consolidation)

**What's in `.apml-registry.json` from this file**:
```json
{
  "PHASE_PROMPTS": {
    "PHASE_1": { "phase": "1", "name": "Pedagogical Translation", "prompt": "..." },
    "PHASE_2": { ... },
    "PHASE_3": { ... }
  }
}
```

**BUT THESE PROMPTS ARE NOT USED!** (see Runtime Analysis below)

---

### 2. APML Directory: `apml/`

**Location**: `/Users/tomcassidy/SSi/ssi-dashboard-v7-clean/apml/`
**Status**: üü° **PARTIALLY MAINTAINED**

**Structure**:
```
apml/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ execution-modes.apml
‚îÇ   ‚îú‚îÄ‚îÄ variable-registry.apml
‚îÇ   ‚îî‚îÄ‚îÄ course-structure.apml
‚îú‚îÄ‚îÄ phases/
‚îÇ   ‚îú‚îÄ‚îÄ phase-1-translation.apml
‚îÇ   ‚îú‚îÄ‚îÄ phase-3-lego-extraction.apml
‚îÇ   ‚îî‚îÄ‚îÄ phase-5-basket-generation.apml
‚îú‚îÄ‚îÄ MONITOR_ALERT.md
‚îî‚îÄ‚îÄ ssi-dashboard-master.apml
```

**Example Content Analysis** (`apml/phases/phase-1-translation.apml`):
- 330 lines of structured orchestration intelligence
- Last updated: 2025-11-10
- Contains: orchestration patterns, workflow steps, validation rules
- Points to: `/skills/translation-skill` directory for actual prompts

**Key Finding**: This is more of a **meta-documentation** layer describing orchestration patterns, NOT the actual prompts used by agents.

---

### 3. APML Registry: `.apml-registry.json`

**Location**: `/Users/tomcassidy/SSi/ssi-dashboard-v7-clean/.apml-registry.json`
**Size**: 135 lines
**Status**: üü¢ **AUTO-GENERATED INDEX** (not SSoT)

**Generated by**: `scripts/compile-apml-registry.cjs`

**Contents**:
```json
{
  "version": "7.8.1",
  "generated_at": "2025-10-28T17:00:00.000Z",
  "apml_file": "ssi-course-production.apml",

  "phase_intelligence": {
    "status": "ACTIVE - Static file serving",
    "location": "docs/phase_intelligence/*.md",
    "access": "GET http://localhost:3456/phase-intelligence/:phase",
    "format": "Markdown text files",
    "modules": {
      "phase_1": { "file": "phase_1_seed_pairs.md", ... },
      "phase_3": { "file": "phase_3_lego_pairs.md", ... },
      "phase_5": { "file": "phase_5_lego_baskets.md", ... }
    }
  },

  "variable_registry": {
    "TOTAL_SEEDS": 668,
    "BATCH_SIZES": { ... },
    "VFS_PATHS": { ... }
  },

  "PHASE_PROMPTS": {
    "PHASE_1": { /* OLD EMBEDDED PROMPTS - DEPRECATED */ }
  }
}
```

**Purpose**:
- **Index/pointer** to actual phase intelligence files
- **Metadata registry** (batch sizes, paths, endpoints)
- **Legacy compatibility** layer (old PHASE_PROMPTS)

**Critical Finding**: The `phase_intelligence` section explicitly says:
```json
"status": "ACTIVE - Static file serving"
"location": "docs/phase_intelligence/*.md"
```

This is the **definitive statement** that markdown files are the SSoT.

---

### 4. Markdown Phase Intelligence: `public/docs/phase_intelligence/`

**Location**: `/Users/tomcassidy/SSi/ssi-dashboard-v7-clean/public/docs/phase_intelligence/`
**Status**: üü¢ **ACTIVE SSOT**

**Files** (21 total, including archive):
```
phase_1_seed_pairs.md              ‚Üê ACTIVE (36KB, Phase 1 methodology)
phase_1_orchestrator.md            ‚Üê ACTIVE (orchestration pattern)
phase_2_collision_check.cjs        ‚Üê Tool (not doc)
phase_3_lego_pairs.md              ‚Üê ACTIVE (13KB)
phase_3_lego_pairs_v7.md           ‚Üê ACTIVE (13KB, latest)
phase_3_orchestrator.md            ‚Üê ACTIVE
phase_5_lego_baskets.md            ‚Üê ACTIVE (19KB, most recently edited: 2025-11-17)
phase_5_orchestrator.md            ‚Üê ACTIVE
phase_5_complete_pipeline.md       ‚Üê ACTIVE
phase_5.5_basket_deduplication.md  ‚Üê ACTIVE
phase_5.5_grammar_review.md        ‚Üê ACTIVE
phase_6_introductions.md           ‚Üê ACTIVE
phase_7_compilation.md             ‚Üê ACTIVE
phase_8_audio_generation.md        ‚Üê ACTIVE
PHASE_EVOLUTION.md                 ‚Üê Meta-doc
README.md                          ‚Üê Catalog

archive/                           ‚Üê Old versions (7 files)
```

**Most Recent Edit**: `phase_5_lego_baskets.md` (2025-11-17 18:17)

**Example Content** (`phase_1_seed_pairs.md`):
- Version: 2.6 (LOCKED 2025-10-28)
- 100+ lines of detailed translation methodology
- TWO ABSOLUTE RULES section
- Learning-by-example patterns
- Cognate preference logic

**Content Comparison**:
- APML has **generic template prompts**
- Markdown has **battle-tested, refined methodology** with examples

---

## Runtime Code Path Analysis

### Where Servers Actually Read From

**File**: `automation_server.cjs` (lines 123-148)

```javascript
// Phase intelligence files
const phaseIntelligenceFiles = {
  '1': 'public/docs/phase_intelligence/phase_1_orchestrator.md',
  '3': 'public/docs/phase_intelligence/phase_3_lego_pairs_v7.md',
  '5': 'public/docs/phase_intelligence/phase_5_lego_baskets.md',
  '5.5': 'public/docs/phase_intelligence/phase_5.5_basket_deduplication.md',
  '6': 'public/docs/phase_intelligence/phase_6_introductions.md',
  '7': 'public/docs/phase_intelligence/phase_7_compilation.md',
  '8': 'public/docs/phase_intelligence/phase_8_audio_generation.md'
};

// Load each phase intelligence file
for (const [phase, filePath] of Object.entries(phaseIntelligenceFiles)) {
  try {
    const fullPath = path.join(__dirname, filePath);
    const intelligence = fs.readFileSync(fullPath, 'utf-8');
    PHASE_PROMPTS[phase] = intelligence;
    console.log(`‚úÖ Loaded Phase ${phase} intelligence from ${filePath}`);
  } catch (error) {
    console.error(`‚ùå Failed to load Phase ${phase} intelligence:`, error.message);
  }
}
```

**FINDING**: Server **directly reads markdown files** at startup, NOT `.apml-registry.json` or `ssi-course-production.apml`.

### Where Dashboard Reads From

**File**: `src/views/PhaseIntelligence.vue` (lines 134-140)

```javascript
import phase1Raw from '../../public/docs/phase_intelligence/phase_1_seed_pairs.md?raw'
import phase3Raw from '../../public/docs/phase_intelligence/phase_3_lego_pairs.md?raw'
import phase5Raw from '../../public/docs/phase_intelligence/phase_5_lego_baskets.md?raw'
import phase5_5Raw from '../../public/docs/phase_intelligence/phase_5.5_basket_deduplication.md?raw'
import phase6Raw from '../../public/docs/phase_intelligence/phase_6_introductions.md?raw'
import phase7Raw from '../../public/docs/phase_intelligence/phase_7_compilation.md?raw'
import phase8Raw from '../../public/docs/phase_intelligence/phase_8_audio_generation.md?raw'
```

**FINDING**: Dashboard **imports markdown files directly** via Vite's `?raw` loader. Zero dependency on APML files.

### Where Agents Get Prompts

**Evidence from grep results**: Multiple agent spawn commands reference:
```
https://raw.githubusercontent.com/thomascassidyzm/ssi-dashboard-v7/main/public/docs/phase_intelligence/phase_5_lego_baskets.md
```

**FINDING**: Agents fetch **live markdown from GitHub** or read local markdown files during task execution.

---

## Content Comparison: APML vs Markdown

### Phase 1 Example

**APML** (`ssi-course-production.apml`, embedded prompt):
- **Generic template**: "Apply 6 pedagogical heuristics..."
- **Length**: ~100 lines
- **Examples**: Minimal
- **Last Update**: Unknown (embedded in v7.7.0 changelog)

**Markdown** (`phase_1_seed_pairs.md`):
- **Battle-tested methodology**: "TWO ABSOLUTE RULES", "ZERO VARIATION", detailed examples
- **Length**: 36KB (extensively documented)
- **Examples**: Multiple language pairs, thinking process demonstrations
- **Version**: 2.6 LOCKED (2025-10-28)
- **Last Update**: Clear versioning with changelog

**Verdict**: Markdown is **vastly more detailed and refined** through production use.

### Phase 5 Example

**APML** (`apml/phases/phase-5-basket-generation.apml`):
- Exists as orchestration pattern doc
- Points to skills/methodology elsewhere
- Not used at runtime

**Markdown** (`phase_5_lego_baskets.md`):
- 19KB of detailed basket generation rules
- **Most recently edited** (2025-11-17 18:17)
- Contains CRITICAL requirements, grammar validation rules
- Active development artifact

**Verdict**: Markdown is the **living document** being actively maintained.

---

## Migration Status Analysis

### Evidence of Migration

1. **`.apml-registry.json` explicitly declares**:
   ```json
   "phase_intelligence": {
     "status": "ACTIVE - Static file serving"
   }
   ```

2. **Archive docs confirm transition**:
   - `public/docs/archive/DISTRIBUTED_SSOT_ARCHITECTURE.md`: "APML grew too large (60k+ lines)"
   - `public/docs/archive/APML_INTELLIGENCE_ARCHITECTURE.md`: Describes move to markdown

3. **Code comments in `automation_server.cjs`**:
   ```javascript
   // Note: Phase intelligence now loaded directly from markdown files
   // To update: Edit the .md files in docs/phase_intelligence/ and restart automation server
   ```

4. **Changelog in `ssi-course-production.apml`** (v7.7.0):
   ```
   DOCUMENTATION UPDATES:
   - Updated TrainingPhase.vue Phase 1/3/5/6/7 prompts with correct filenames
   - Created docs/APML_v7.0_CURRENT_FORMAT.md as format reference
   ```

### What Remains in APML

**Still Used**:
- ‚úÖ Variable registry (batch sizes, paths, constants)
- ‚úÖ System metadata (version, architecture)
- ‚úÖ Schema references (data structure specs)

**Deprecated/Legacy**:
- ‚ùå Phase prompts embedded in `ssi-course-production.apml`
- ‚ùå PHASE_PROMPTS in `.apml-registry.json` (kept for backwards compatibility)

### What's in Markdown

**Primary Content**:
- ‚úÖ Phase methodologies (all 8 phases)
- ‚úÖ Translation rules and heuristics
- ‚úÖ LEGO extraction algorithms
- ‚úÖ Basket generation constraints
- ‚úÖ Validation requirements

**Active Maintenance**:
- Latest edit: 2025-11-17 (phase_5_lego_baskets.md)
- Version tracking within files
- Archive directory for old versions

---

## Definitive Answers to Key Questions

### Q: Is APML still used or deprecated?

**A**: **PARTIALLY DEPRECATED**

- **Deprecated**: Phase intelligence prompts (moved to markdown)
- **Active**: Variable registry, system metadata, schema references
- **Transitional**: `.apml-registry.json` acts as index/pointer to markdown

### Q: Do servers read from APML files or markdown?

**A**: **MARKDOWN**

**Evidence**:
1. `automation_server.cjs` lines 123-148: Direct `readFileSync` of markdown files
2. `PhaseIntelligence.vue` lines 134-140: Vite imports of markdown files
3. Agent spawn commands: Reference GitHub raw markdown URLs
4. Zero code reading `ssi-course-production.apml` for phase prompts

### Q: Is the .apml-registry.json auto-generated or manual?

**A**: **AUTO-GENERATED** (but not from what you'd expect)

**Generator**: `scripts/compile-apml-registry.cjs`

**Source Data**:
- Reads `ssi-course-production.apml` for legacy PHASE_PROMPTS
- Hardcodes variable registry values
- Hardcodes phase_intelligence metadata (pointing to markdown)

**Output**: Index file with pointers to actual SSoT (markdown)

**Manual Aspect**: The script itself is manually maintained, but the `.json` output is generated.

### Q: What's the relationship between ssi-course-production.apml and phase docs?

**A**: **HISTORICAL RELATIONSHIP, NOW DECOUPLED**

**Original Design**:
- `ssi-course-production.apml` was meant to be the single SSoT
- All phase intelligence embedded in APML structure

**Current Reality**:
- Phase intelligence **extracted to markdown** (public/docs/phase_intelligence/)
- APML file kept for **metadata and registry** only
- `.apml-registry.json` acts as **bridge/index** between old and new

**Relationship Today**:
```
ssi-course-production.apml (legacy prompts)
        ‚Üì [compiled by]
.apml-registry.json (index/pointer)
        ‚Üì [points to]
public/docs/phase_intelligence/*.md (ACTIVE SSOT)
        ‚Üì [loaded by]
automation_server.cjs / PhaseIntelligence.vue (runtime)
```

---

## Source of Truth Determination

### üü¢ ACTIVE SSOT: Markdown Files

**Location**: `public/docs/phase_intelligence/*.md`

**Authority**:
- ‚úÖ Read directly by automation_server.cjs
- ‚úÖ Imported directly by dashboard Vue components
- ‚úÖ Fetched by agents from GitHub
- ‚úÖ Most recently edited (2025-11-17)
- ‚úÖ Version-tracked within files

**Update Process**:
1. Edit markdown file in `public/docs/phase_intelligence/`
2. Restart automation server (it reads files on startup)
3. Dashboard auto-updates (Vite hot reload)

### üü° TRANSITIONAL: .apml-registry.json

**Location**: `.apml-registry.json`

**Authority**:
- ‚ö†Ô∏è Generated artifact (NOT source)
- ‚úÖ Useful as index/catalog
- ‚úÖ Contains variable registry (batch sizes, paths)
- ‚ùå NOT read by runtime code for phase intelligence

**Update Process**:
1. Run: `node scripts/compile-apml-registry.cjs`
2. Commits to git for reference

### üî¥ DEPRECATED: APML Phase Prompts

**Location**: `ssi-course-production.apml` (embedded PHASE_PROMPTS)

**Authority**:
- ‚ùå NOT used by any runtime code
- ‚ùå Out of sync with markdown
- ‚ö†Ô∏è Legacy compatibility only

**Status**: Keep for historical reference, but DO NOT EDIT for phase updates.

---

## Migration Roadmap

Based on evidence, the migration is **mostly complete**, but cleanup needed:

### ‚úÖ Already Migrated

- [x] Phase 1 intelligence ‚Üí `phase_1_seed_pairs.md`
- [x] Phase 3 intelligence ‚Üí `phase_3_lego_pairs_v7.md`
- [x] Phase 5 intelligence ‚Üí `phase_5_lego_baskets.md`
- [x] Phase 5.5 intelligence ‚Üí `phase_5.5_basket_deduplication.md`
- [x] Phase 6 intelligence ‚Üí `phase_6_introductions.md`
- [x] Phase 7 intelligence ‚Üí `phase_7_compilation.md`
- [x] Phase 8 intelligence ‚Üí `phase_8_audio_generation.md`
- [x] Runtime code updated to read markdown
- [x] Dashboard updated to import markdown

### üîÑ In Progress / Needs Clarity

- [ ] Phase 2 intelligence (no markdown file found - possibly skipped?)
- [ ] Orchestrator patterns in `apml/phases/` - unclear if maintained or deprecated
- [ ] Skills directory integration (referenced in phase_1 APML)

### üßπ Cleanup Needed

1. **Remove or clearly mark deprecated** embedded PHASE_PROMPTS in `ssi-course-production.apml`
   - Option A: Delete entirely
   - Option B: Add deprecation notice at top of file

2. **Clarify `apml/` directory purpose**
   - Is it meta-documentation? Reference architecture?
   - Should it be archived or actively maintained?

3. **Update `.apml-registry.json` generation**
   - Remove generation of legacy PHASE_PROMPTS (if not needed for compatibility)
   - OR add deprecation notice in generated JSON

4. **Document migration completion**
   - Create `MIGRATION_COMPLETE.md` documenting:
     - What moved to markdown
     - What stayed in APML (and why)
     - Update workflow for both

---

## Deprecation Plan for Old APML

### Immediate Actions (Low Risk)

1. **Add deprecation notice to `ssi-course-production.apml`**:
   ```yaml
   # DEPRECATION NOTICE (2025-11-17)
   # Phase intelligence has been migrated to markdown files.
   # This file is maintained for:
   #   - Variable registry (TOTAL_SEEDS, BATCH_SIZES, VFS_PATHS)
   #   - System metadata (version, architecture)
   #   - Historical reference
   #
   # DO NOT EDIT PHASE_PROMPTS SECTIONS - they are not used.
   # Edit: public/docs/phase_intelligence/*.md instead
   ```

2. **Add deprecation to `.apml-registry.json` generation**:
   ```javascript
   "PHASE_PROMPTS": {
     "_deprecation_notice": "2025-11-17 - Use phase_intelligence.modules instead",
     "_status": "Legacy compatibility only - not used by runtime",
     "PHASE_1": { ... }
   }
   ```

3. **Update README.md** with current architecture:
   ```markdown
   ## Phase Intelligence SSoT

   Phase methodologies are stored in markdown:
   - Location: `public/docs/phase_intelligence/`
   - Format: Markdown with version tracking
   - Update: Edit markdown directly, restart automation server

   APML is used for:
   - Variable registry (batch sizes, paths)
   - System metadata
   - Historical reference
   ```

### Medium-Term Actions (Requires Testing)

4. **Remove unused APML phase prompt extraction** from `compile-apml-registry.cjs`:
   - Keep variable registry compilation
   - Remove PHASE_PROMPTS extraction (or mark as deprecated)
   - Add phase_intelligence metadata from directory scan

5. **Archive `apml/phases/` directory** (if not actively used):
   - Move to `archive/apml-v7/phases/`
   - Keep for reference but make clear it's historical

6. **Consolidate documentation**:
   - Single `ARCHITECTURE.md` explaining current state
   - Clear "What's APML, what's markdown, what's deprecated"

### Long-Term Actions (Breaking Changes)

7. **Remove legacy PHASE_PROMPTS** from `.apml-registry.json` entirely:
   - Only if no code depends on it
   - Audit all references first
   - Create v8.0 breaking change

8. **Convert remaining APML** to structured YAML/JSON:
   - Simpler than custom APML format
   - Standard tooling support
   - Or keep as human-readable config

---

## Recommendations

### For Developers

1. **Edit phase intelligence**: Modify markdown in `public/docs/phase_intelligence/`
2. **Edit variables/config**: Modify `ssi-course-production.apml` variable registry section
3. **Update registry**: Run `node scripts/compile-apml-registry.cjs` after APML edits
4. **Restart servers**: `pm2 restart automation-server` after any prompt changes

### For System Maintenance

1. **Mark APML clearly** as "metadata only, phase prompts deprecated"
2. **Document the transition** in a single authoritative doc
3. **Archive old APML directories** that aren't actively used
4. **Test removal** of PHASE_PROMPTS from registry (if nothing breaks)

### For Future Architecture

1. **Consider**: Full migration to markdown + YAML config (drop APML format entirely)
2. **Consider**: Database-backed prompt versioning (if editing via UI is desired)
3. **Consider**: Git-based prompt history (already partially there with markdown)

---

## Conclusion

**The Truth**:
- **Markdown files are the SSoT** for phase intelligence (100% certainty)
- **APML still has a role** for variable registry and metadata
- **`.apml-registry.json` is an index**, not a source of truth
- **Migration is ~95% complete**, cleanup needed

**Key Action**: **Add deprecation notices** to APML phase prompts to prevent confusion.

**Next Steps**:
1. Clarify purpose of `apml/` directory (archive or keep?)
2. Document current architecture in single source
3. Remove or deprecate unused legacy code paths

**No longer ambiguous**: Markdown files in `public/docs/phase_intelligence/` are definitively the active, maintained, runtime-used source of truth for all phase methodologies.

---

**Audit Complete**: 2025-11-17
**Confidence Level**: High (forensic code trace, multiple confirming sources)
